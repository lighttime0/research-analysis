### Abstract
Canopy是一种普遍的跟踪基础架构，用于记录和处理性能跟踪，将端到端执行路径的性能数据与结构化和因果相关的执行跟踪相结合，以实现定制性能分析

跟踪近实时，导出用户指定的功能，并输出到聚合了数十亿个请求的性能数据集。三个挑战：
- 不同组件使用的执行和更多的性能模型
- 支持性能数据的交互式特点分析
- 用户深入定制，从采样轨迹到提取和可视化功能
### 1 Introduction
FaceBook 影响性能的因素：
- 通过异构客户端（包括Web浏览器和移动应用程序）访问Facebook，从而提供不同级别的信息和对应用程序的控制（Facebook.com上加载一个页面，都需要跨客户端，网络和分布式后端服务的复杂执行）
- 动态因素还会影响性能，例如持续部署新代码，更改配置

Canopy通过一个完整的管道从堆栈中的系统生成的跟踪中提取性能数据，包括浏览器，移动应用程序和后端服务：
- 在开发阶段，Facebook工程师可以使用针对不同执行模式量身定制一系列的API
- 在运行时，Canopy将生成的性能数据映射到灵活的基于事件的表示
- Canopy的后端管道在近距离接收事件; 重构分析查询更加便利的高级跟踪模型; 从痕迹中提取用户指定的特征; 并将结果输出到用于自定义聚合可视化的数据集

### 2 Motivation
之前做的跟踪系统专门针对特定用例，难以扩展到其他域，很难获得跨系统洞察力。

不能处理实践中出现的各种各样的问题。每个系统支持的分析类型也相当僵化，变化需要几天才能部署

#### 2.1 Canopy in Action
例子：
- 1.特定页面初始部分所需的平均时间为300ms，约为13％
- 2.记录请求的端到端跟踪来计算此度量，包括在浏览器和Facebook后端执行。实时地接收痕迹，导出一系列指标，包括每个迹线的页面加载延迟，并将其导引到各种长期的性能指标数据集
- 3.从构成组件的页面加载时间开始，服务器执行时间和网络时间相对不变，浏览器执行时间和资源获取时间提高了
- 4.诊断资源加载时间的变化
- 5.Canopy的数据集进一步按照页面片段细分细分度量标准，并按页面进行分组，UserInput页面片段已将另外10kB的CSS添加到页面加载关键路径
#### 2.2 Challenges
- 建模跟踪数据
  
  + 性能跟踪包含来自所有组件的请求，从客户端到后端服务的执行路径的各种信息
  + 各种各样的定制系统设计，第三方代码和其他限制这些核心框架的使用的问题
  + 跨越多个服务
  
- 分析数据
 
  + 基于所有跟踪中的任意特征来查看，过滤和汇总指标
  + 查询痕迹，包括历史数据，可以适用于极大量的痕迹（每天13亿条）：实时查询？
  
- 支持多种用例

### 3 Design
提供一个管道来解决这些挑战，用于从堆栈中的系统生成的跟踪中提取性能数据。并在管道的每个步骤都强调用户定制，并提供组件之间的关注分离，以允许其个体演化
#### 3.1 Canopy Overview

- 将每个请求分配给唯一的TraceID，并沿着请求的端到端执行路径进行传播
- 在执行期间生成捕获与先前事件相关的性能信息和因果关系的事件
- 在内部，所有的工具API映射到一个常见的底层事件表示

处理：
- 由TraceID分片，后端处理，并将其持续存储
- 确定已经接收到请求的所有事件，它们将排队处理
- 处理开始，将事件映射到跟踪模型
- 从每个建模的跟踪中提取或计算有趣的特征，评估用户提供的特征
- 数据集被管道传输到专为性能数据设计的内存数据库
- 工程师可以直接查询数据集，查看数据集支持的可视化

#### 3.2 Instrumentation APIs

三个任务：？
- 执行跟踪请求的同时传播TraceID，以便将不同组件生成的性能数据相关联
- 记录请求结构，例如 执行的时间和时间，线程和组件之间的因果关系以及网络通信
- 捕获有用的性能数据，例如。 日志记录语句，性能计数器和堆栈跟踪

#### 3.3 Trace Events
不将单个执行或性能模型指定为唯一可能的跟踪表示，Canopy跟踪具有基于事件的通用底层表示







